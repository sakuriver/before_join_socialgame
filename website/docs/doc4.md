---
id: doc4
title: 3章:運用を見据えて作っておこう
sidebar_label: 3章:運用を見据えて作っておこう
---
ソーシャルゲームの良いところは、初動で遊んでくれたユーザだけでなく、継続的に遊んでくれたり、半年後から遊んでくれるユーザがいることです。
（悪いところはマスターアップ休暇が無いところです！！古き良き時代はリフレッシュできたのに！）

運用は開発と同じくらい（場合によってはそれ以上に）大切なことです。クライアントエンジニアとしては、リリースして半分、運用して半分、くらいの意識でいたいですね。

## プッシュ通知
**一言で言うとどんなもの？**

ユーザに対して「イベントが始まるよ」「お得なキャンペーンが！」「友達が呼んでるよ」などをアプリ起動していないときもメッセージを送りたいです。

でも通知が多すぎるとユーザは鬱陶しいと思って通知をオフにしたり、ゲームを消してしまいます。ぎゃふん…

適切なプッシュ通知によってユーザのマインドシェアを維持して、アクティブユーザを保つためにも、このプッシュ通知は気合いを入れていきましょう。

最初はメチャクチャ混乱すると思いますが、プッシュ通知というのは「ローカルプッシュ通知」と「サーバプッシュ通知」という**2種類の概念があります。**  
2種類の内、ローカルプッシュ通知はUnity公式パッケージがあります https://docs.unity3d.com/Packages/com.unity.mobile.notifications@1.0/manual/ 

が、**ソーシャルゲームで実際コレを使うことはほとんどありません。**　なぜなら、 **ローカルプッシュ通知はアプリをキルしていると届かないためです。**

多くのユーザは、使っていないアプリをキルする習慣を持っています。そのため、ローカルプッシュ通知は全然届きません。  


そのためソーシャルゲームにおいては、 ユーザがインストールして通知許可していれば、**アプリを起動していなくてもプッシュ通知が送れるサーバプッシュ通知を使います。**　Firebase Cloud Messagingを使うことが多いと思います。


**これの理解や実装が不完全だと何が起きるの？**

- 全体通知しか送れなくて運用施策打てなくて詰む
- アイテムプレゼントプッシュ通知を想定してなくて運用施策打てなくて詰む

**詳しく知りたい人は、この辺の単語でググってほしい**

- Firebase for Unity
- APNS ,Firebase Cloud Messeging(FCM)

### FirebaseCloudMessaging(FCM)
事実上のデファクトスタンダードなプッシュ通知SDKです。GooglePlayStoreとAppStoreを対象にするならこれが多いです。(Xiaomiストアとか中国を視野に入れるとまた事情が変わってきます)   
GooglePlayStoreはFCMしか選択肢が無い（他のSDKも、内部で結局このSDKを叩いている）です。

AppStoreの場合はAPNSがデフォルトのプッシュ通知システムで、FCMはiOS向けにAPNSをラップして居る。という状況です。
正直なところプッシュ通知はユーザ数が増えたり、一斉送信するときに、思わぬハマりポイントがあるので、有識者に相談する事をオススメします。

そしてこのドキュメントを読んでいるあなたも、遊んでいるソーシャルゲームで、いかにも誤送信っぽい一斉送信なテストのプッシュ通知を見ることがあるかもしれません。  
見かけたときは、 **Twitterに誤送信プッシュ通知スクショをアップして笑いものにするのは止めて** くださると助かります。本当に…人に優しくなろう…人は分かり合えますから…

### サーバプッシュ通知基盤
ゲームのユーザ全体にプッシュ通知を送る、というのを頻繁に行っていると、プッシュ通知をオフにされてします。

そのため、必要なユーザに、必要な事だけを通知する、という気持ちで設計する必要があります。これを行うために必要なのがサーバプッシュ通知基盤です。
社内に既にあれば安心ですし、無い場合はFirebase Analysticsと組み合わせたユーザ属性のフィルタ、ログイン頻度ベースのフィルタ、ゲーム固有のレベルベースのフィルタなどを駆使して、必要な事だけをプッシュ通知で送っていきましょう。


## マスターデータダウンロード
**一言で言うとどんなもの？**

「〇〇っていう敵が強すぎ、修正！」「説明文が誤字ってた、こっそり直したい！」みたいな時に効果を発揮します。
アセットバンドルとは別でメチャクチャ大きいcsvやjsonファイルをダウンロードする手段を用意しておくことが多い気がします。

**これの理解や実装が不完全だと何が起きるの？**
- 誤字脱字修正したいだけなのにアプリ審査必須
- 5MBのマスターデータjsonをパースしようとしてメモリ少ない端末が毎回クラッシュ

**詳しく知りたい人は、この辺の単語でググってほしい**
- Unity Remote Config
- マスターデータ csv 運用
- Firebase Cloud Firestore

### Firebase Cloud Firestore
### 自社基盤
### エディタ拡張
## アセットバンドル
これ読んでもらえれば…  
https://qiita.com/neon-izm/items/b105130fac060ec40ad4

### AddressableAssetSystems(AAS)かAssetBundle(AB)か
UnityのAssetBundleは、かなり低レイヤーのAPIだけが用意されている状況でした。そのため各社がオレオレAssetBundleManagerを作っている、という状況でした。

それに対してUnity側がある程度の高レイヤーなシステムとしてAddressableAssetSystems(AAS)を提供しました。Unity2018.3以降であれば使うことが出来ます。
AASはABをラップした仕組みですが、触っていくとABの挙動を理解していないと意味不明になることがあるので、一旦ABを覚えておくのが良い気がします。

両者は対立する概念では無く低レベルAPIなのか高レベルAPIなのか、という感じの理解をしておくと良いと思います。
もしプロジェクトにこういった基盤が何も無ければ、おすすめとしてはAASです。あるいはABを使う場合はAutoyaを検討してください。僕のオススメUnityフレームワークです。

### AssetBundle用のプロジェクトを分離するか同一運用するか
AssetBundleのビルドは時間が掛かる上に、リポジトリサイズも肥大化しがちです。  
例えばデザイナーさんが「新章のキャラデータを100MBほど追加しました！！」とコミットしたときに、クライアントエンジニアが全員100MBのキャラデータをgit pullしてimportが走ります。

それはちょっと作業効率的に良くないのではないか、ということで「アセットバンドルをビルドしてストレージサーバにアップする」だけの別プロジェクトを作る、と言う運用を行っているソーシャルゲームもあります。

- メインロジック、UI、アウトゲーム用リポジトリ（ほとんどのクライアントエンジニアはこれを使う）
- キャラデータや素材を詰め込んでビルドするAssetBundle用（デザイナーやアートの人と協力する人たちはこれも使う）

みたいな運用です。

参加したプロジェクトがこの形式であれば、合わせましょう。

ただし、私見を言うと単一プロジェクト運用がこれからは増えていきそうな予感があります。以下が理由です。

- 動作確認フローが複雑になりやすい(確認に掛かる作業が複雑になると、面倒くさがって検証が雑になりやすいです)
- 最新UnityではAssetImporter v2が入ったのでインポート速度は改善傾向にある
- また、AASでもローカル-リモートのアセットバンドルロード切り替えを備えているけど、単一プロジェクト前提のコードになっている
- 速いPC、速いCI、十分な回線速度があれば単一プロジェクトにまとめた運用でも意外と回る


## 機種変引継ぎ対応
ここまでに何度か「機種変更時の引継ぎ」という言葉が出てきました。あなたも遊んでいたゲームが機種変更時にセーブデータを引継げなくて悲しい思いをしたことがあるかもしれません。

経験上、**引継ぎ失敗した時に、サポートにお問い合わせをしてくれるユーザの割合はかなり低いです。無言でゲームから離れていきます。** メチャクチャ悲しいです。  
そのため、機種変更引継ぎ部分はしっかり作っておくと、ちょっとしたイベント運用やUI改善よりも離脱率に効いてくる大事なポイントだと思っています。

上記の匿名ログインでゲームを始めたユーザに対して「そろそろメールアドレスとパスワードの登録もしてみませんか？（あるいは引継ぎ情報を登録しませんか）」とゲーム内で案内を行います。  
その際、登録してくれた場合にちょっとしたプレゼントやユーザの利益になる（たとえば魔法石500個とか）ようにしておきましょう。  

ユーザが**メールアドレスを手打ちして、パスワードを考えて登録して、メールアプリを開いて、メール本文のリンクを踏んで、ブラウザ側で認証を確認する、というのはメチャクチャ大変な大作業**なので、大作業を行ってくれたユーザが気分良くゲームを続けられそうなプレゼントを提案しましょう。

出来ればユーザが気分良く遊んでいる時に邪魔しないタイミングで、なおかつちょっと良いことがあったタイミングを見計らって案内していきましょう（ストアレビュー依頼も同じ考え方です）


**一言で言うとどんなもの？**  

新しい端末へ、サーバ上にあるユーザーデータの紐づけを行います。

ソーシャルゲームでは、主にサーバ側でユーザーデータを保管しています。
機種変更で旧端末から新端末へゲームデータを移行したい場合などに使用します。

**これの理解や実装が不完全だと何が起きるの？**  

- 致命的なバグとしては、ユーザーデータ消失や他人のデータでの誤引継ぎがされてしまうこともあり得ます
- 認証の仕方が甘いとアカウント乗っ取りに利用されてしまうことさえあります
- ユーザーが今まで費やしてきた時間やお金が絡んでくるため、会社としての信用問題に関わります

**AppStore規約における注意点**  
　2017年のApple審査ガイドライン変更で「単一の引継ぎコード」を用いた引継ぎ実装はリジェクトされることとなりました。
　2020年現在では主に

- プレイヤーID＋引継ぎコード
- プレイヤーID＋任意のパスワード
- メールアドレス＋引継ぎコード
- メールアドレス＋任意のパスワード
- 自社サービスアカウント
- 外部サービスアカウント  

などを用いた引継ぎが主流となっています。自社サービスアカウントが既にあるなら自社サービスアカウントを使うのが一番オススメです！

### お問い合わせ識別
ゲーム内にお問い合わせを送る画面を用意しておきましょう。これを用意しておくと、ユーザからのフィードバック頻度がだいぶ変わります。

## メンテナンスモードを作ろう
**一言で言うとどんなもの？**

運用があるゲームはメンテナンス無しで続けることは、ほとんど不可能です。  
そのためサーバのメンテ状態を確認して、メンテ中なら「メンテ中です！」とダイアログを出す（出来れば終了予定やお知らせを差し込む）
仕組みが必要です。

これは大体サーバのresponseステータスコードをメンテ用に定義しておいて、http response時に判定してメンテ中なら無限ダイアログを出す、という方式にします。

**これの理解や実装が不完全だと何が起きるの？**
- メンテ中にアクセスするユーザがいてデータ不整合で凄い事になります。
- チームメンバーからすごく怒られます

**詳しく知りたい人は、この辺の単語でググってほしい**
- https://sassembla.github.io/Autoya/docs/en/turn_on_maintenance0.html

## アプリのクラッシュレポート収集
**一言で言うとどんなもの？**

リリースのたびにアプリが絶対にクラッシュしないことを保証するのは非常に難しいです。   
機能追加によって新しいバグができたり、利用するライブラリにバグがあるなど様々な原因でアプリは落ちるため、開発中にすべてのバグを見つけるのは困難を極めます。

バグの早期発見のため、アプリを利用しているユーザーから提供されるエラーログやクラッシュレポートを分析してバグの特定の足がかりにします。   
スマホのアプリの場合は自動化するフレームワークを導入することがほとんどです。

**これの理解や実装が不完全だと何が起きるの？**
- 毎回テスターのバグチェックに依存するため、バグの発見が遅くなります
- **特定の端末のみで発生しているバグ** などはさらに発見が遅くなります
- アプリのユーザー評価を大きく下げる原因になります

**詳しく知りたい人は、この辺の単語でググってほしい**
- Firebase Crashlytics
- Sentry
- Unity Cloud Diagnostics (これはあんまり使われてないかも？)

## KPI (重要業績評価指標)
**一言で言うとどんなもの？**

ユーザーの行動を分析して、今後の運用や機能追加の方針を決めるための指標です。

「何割のユーザーが課金してくれたんだろう」とか「どこでやめてしまうユーザーが多いんだろう」などを統計で出すことで、今後の機能追加の方針を決めたり、「ユーザーはこんな行動をするんだ…ふ～ん」と納得したりします。

基本的に、AdjustやUnity AnalyticsといったKPIサービスを利用し、ソースコードの適所にKPI用のコードを仕込む事で統計を取ります。

**これの理解や実装が不完全だと何が起きるの？**
- ユーザーにとって必要ない機能を追加して、無駄に時間を取られます
- マネタイズで失敗して今後の運用に支障をきたしてしまいます
- 無能運営と罵られます

**詳しく知りたい人は、この辺の単語でググってほしい**
- https://hajime-blog.net/work/kpibasic-part1
- https://yuranhiko.hatenablog.com/entry/Game_KPI/001

### 用語
#### DAU (プレイ人数/日)
#### MAU (プレイ人数/月)
#### DPU (課金率)
#### ARPPU (課金単価)
#### 継続率

## お知らせ


**一言で言うとどんなもの？**

運用があるゲームは、何かしらの不具合解消や改善をしていきます。  
そのためメンテンナンス明けに、ゲームのトップで”ボタンを改善したよ”とか”ゲームが動かなくなったのを直して、無料の詫び石配ったよ”
仕組みが必要です。

これは大体サーバのお知らせ情報取得apiに追加しておいて、詳細は専用のダイアログや別ページで表示します。

**これの理解や実装が不完全だと何が起きるの？**
- メンテ中に何が治ったか開発した人以外不明になります。
- チームメンバーが対応したのにって(*'ω'*)、、、みたいな顔をされてしまいます
- 水着とか、クリスマスコスとかお正月イベントがやりにくい

**詳しく知りたい人は、この辺の単語でググってほしい**
- メンテ明け
- マラソンイベント
- 詫び石




